<!doctype html>
<html>
  <head>
    <title>MultiBandit Example</title>
  </head>
  <body>
    <h1>Multi Fruit or Treats Bandit</h1>
    <p>
      This is an example of a MultiBandit that generates a slate of multiple
      recommendations.
    </p>
    <p>You can pick either of the options, or none of the above.</p>
    <p>
      When you select one item, we generate three pieces of training data: one
      for the item selected, and two for the items not selected.
    </p>
    <p>
      We also have action features, with items either being a fruit or a treat
    </p>

    <h2>Learning Rate:</h2>
    <p>
      Higher learning rates mean that the bandit will learn faster, but will
      also forget faster.
    </p>
    <input type="number" id="learning-rate" value="0.1" step="0.1" />

    <h2>Temperature:</h2>
    <p>
      Lower temperature mean that the bandit will be more likely to choose the
      action with the highest score (exploit), higher temperature means that the
      bandit is more likely to choose the actions with a lower score
      (exploration)
    </p>
    <input type="number" id="temperature" value="0.2" step="0.1" />

    <h2>All action probabilities:</h2>
    <div id="action-probabilities"></div>

    <h2>Recommendation JSON:</h2>
    <div id="slate-json"></div>

    <h2>Weather:</h2>
    <div id="weather"></div>

    <h2>Recommended fruits:</h2>
    <div id="recommended-fruits"></div>

    <button id="eat-1">Eat first</button>
    <button id="eat-2">Eat second</button>
    <button id="eat-3">Eat third</button>
    <button id="dont-eat-button">Don't eat any</button>

    <h2>Training Data</h2>
    <div id="training-data"></div>

    <h2>JSON serialized bandit</h2>
    <div id="serialized-bandit"></div>

    <p><a href="index.html">Back to index</a></p>

    <script src="../../dist/browser/simpleBandit.js"></script>
    <script>
      let learningRateInput = document.getElementById("learning-rate");
      let temperatureInput = document.getElementById("temperature");
      let learningRate = parseFloat(learningRateInput.value);
      let temperature = parseFloat(temperatureInput.value);

      let bandit = new SimpleBandit({
        oracle: new SimpleOracle({ learningRate: learningRate }),
        actions: {
          apple: { fruit: 1 },
          pear: { fruit: 1 },
          orange: { fruit: 1 },
          chocolate: { treat: 1 },
          candy: { treat: 1 },
          cake: { treat: 1 },
        },
        temperature: temperature,
        slateSize: 3,
      });
      let slate;
      let trainingData = [];
      let context;

      learningRateInput.addEventListener("change", function () {
        learningRate = parseFloat(learningRateInput.value);
        bandit.oracle.learningRate = learningRate;
      });
      temperatureInput.addEventListener("change", function () {
        temperature = parseFloat(temperatureInput.value);
        bandit.temperature = temperature;
        document.getElementById("action-probabilities").innerText =
          JSON.stringify(bandit.getScoredActions(context));
      });

      function generateNewRecommendation() {
        const weather = ["sunny", "rainy"][Math.floor(Math.random() * 2)];
        context =
          weather == "sunny" ? { sunny: 1, rainy: 0 } : { sunny: 0, rainy: 1 };
        slate = bandit.slate(context);

        let slateActionsString = "";
        for (let i = 0; i < slate.slateActions.length; i++) {
          slateActionsString += `${i + 1}: ${slate.slateActions[i].actionId}\n`;
        }
        document.getElementById("weather").innerText = weather;
        document.getElementById("recommended-fruits").innerText =
          slateActionsString;
        document.getElementById("slate-json").innerText = JSON.stringify(slate);
        let scoredActions = bandit.getScoredActions(context);
        scoredActions.sort(function (a, b) {
          return b.probability - a.probability;
        });
        document.getElementById("action-probabilities").innerText =
          scoredActions
            .map(function (scoredAction) {
              return (
                scoredAction.actionId +
                " (" +
                (scoredAction.probability * 100).toFixed(1) +
                "%)"
              );
            })
            .join(", ");
      }

      generateNewRecommendation();

      document
        .getElementById("eat-1")
        .addEventListener("click", async function () {
          actionId = slate.slateActions[0].actionId;
          newTrainingData = await bandit.choose(slate, actionId);
          trainingData = trainingData.concat(newTrainingData);
          document.getElementById("training-data").innerText =
            JSON.stringify(trainingData);
          document.getElementById("serialized-bandit").innerText =
            bandit.toJSON();
          generateNewRecommendation();
        });
      document
        .getElementById("eat-2")
        .addEventListener("click", async function () {
          actionId = slate.slateActions[1].actionId;
          newTrainingData = await bandit.choose(slate, actionId);
          trainingData = trainingData.concat(newTrainingData);
          document.getElementById("training-data").innerText =
            JSON.stringify(trainingData);
          document.getElementById("serialized-bandit").innerText =
            bandit.toJSON();
          generateNewRecommendation();
        });
      document
        .getElementById("eat-3")
        .addEventListener("click", async function () {
          actionId = slate.slateActions[2].actionId;
          newTrainingData = await bandit.choose(slate, actionId);
          trainingData = trainingData.concat(newTrainingData);
          document.getElementById("training-data").innerText =
            JSON.stringify(trainingData);
          document.getElementById("serialized-bandit").innerText =
            bandit.toJSON();
          generateNewRecommendation();
        });

      document
        .getElementById("dont-eat-button")
        .addEventListener("click", async function () {
          newTrainingData = await bandit.reject(slate);
          trainingData = trainingData.concat(newTrainingData);
          document.getElementById("training-data").innerText =
            JSON.stringify(trainingData);
          document.getElementById("serialized-bandit").innerText =
            bandit.toJSON();
          generateNewRecommendation();
        });
    </script>
  </body>
</html>
