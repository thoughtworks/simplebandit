<!doctype html>
<html>
  <head>
    <title>MultiBandit Example</title>
  </head>
  <body>
    <h1>Multi Fruit or Treats Bandit</h1>
    <p>
      This is an example of a MultiBandit that generates a slate of multiple
      recommendations.
    </p>
    <p>You can pick either of the options, or none of the above.</p>
    <p>
      When you select one item, we generate three pieces of training data: one
      for the item selected, and two for the items not selected.
    </p>
    <p>
      We also have action features, with items either being a fruit or a treat
    </p>

    <h2>Learning Rate:</h2>
    <p>
      Higher learning rates mean that the bandit will learn faster, but will
      also forget faster.
    </p>
    <input type="number" id="learning-rate" value="0.5" step="0.1" />

    <h2>Softmax Beta:</h2>
    <p>
      Higher softmax betas mean that the bandit will be more likely to choose
      the action with the highest score.
    </p>
    <input type="number" id="softmax-beta" value="3.0" step="0.1" />

    <h2>All action probabilities:</h2>
    <div id="action-probabilities"></div>

    <h2>Recommendation JSON:</h2>
    <div id="recommendation-json"></div>

    <h2>Recommended fruits:</h2>
    <div id="recommended-fruits"></div>

    <button id="eat-1">Eat first</button>
    <button id="eat-2">Eat second</button>
    <button id="eat-3">Eat third</button>
    <button id="dont-eat-button">Don't eat any</button>

    <h2>Training Data</h2>
    <div id="training-data"></div>

    <h2>JSON serialized bandit</h2>
    <div id="serialized-bandit"></div>

    <script src="../simpleBandit.js"></script>
    <script>
      let learningRateInput = document.getElementById("learning-rate");
      let temperatureInput = document.getElementById("softmax-beta");
      let learningRate = parseFloat(learningRateInput.value);
      let temperature = parseFloat(temperatureInput.value);

      const actions = [
        {
          actionId: "apple",
          features: { fruit: 1, treat: 0 },
        },
        {
          actionId: "pear",
          features: { fruit: 1, treat: 0 },
        },
        {
          actionId: "orange",
          features: { fruit: 1, treat: 0 },
        },
        {
          actionId: "chocolate",
          features: { fruit: 0, treat: 1 },
        },
        {
          actionId: "candy",
          features: { fruit: 0, treat: 1 },
        },
        {
          actionId: "cake",
          features: { fruit: 0, treat: 1 },
        },
      ];

      let bandit = MultiBandit.fromContextAndActions({
        context: ["sunny", "rainy"],
        actions: actions,
        temperature: temperature,
        learningRate: learningRate,
        nRecommendations: 3,
      });
      let recommendation;
      let trainingData = [];
      let context;

      learningRateInput.addEventListener("change", function () {
        learningRate = parseFloat(learningRateInput.value);
        bandit.oracle.learningRate = learningRate;
      });
      temperatureInput.addEventListener("change", function () {
        temperature = parseFloat(temperatureInput.value);
        bandit.temperature = temperature;
        document.getElementById("action-probabilities").innerText =
          JSON.stringify(bandit.getScoredActions(context));
      });

      function generateNewRecommendation() {
        const weather = ["sunny", "rainy"][Math.floor(Math.random() * 2)];
        context =
          weather == "sunny" ? { sunny: 1, rainy: 0 } : { sunny: 0, rainy: 1 };
        recommendation = bandit.makeRecommendation(context);

        let recommendedActionsString = "";
        for (let i = 0; i < recommendation.recommendedActions.length; i++) {
          recommendedActionsString += `${i + 1}: ${
            recommendation.recommendedActions[i].actionId
          }\n`;
        }
        document.getElementById("recommended-fruits").innerText =
          recommendedActionsString;
        document.getElementById("recommendation-json").innerText =
          JSON.stringify(recommendation);
        let scoredActions = bandit.getScoredActions(context);
        scoredActions.sort(function (a, b) {
          return b.probability - a.probability;
        });
        document.getElementById("action-probabilities").innerText =
          scoredActions
            .map(function (scoredAction) {
              return (
                scoredAction.actionId +
                " (" +
                (scoredAction.probability * 100).toFixed(1) +
                "%)"
              );
            })
            .join(", ");
      }

      generateNewRecommendation();

      document
        .getElementById("eat-1")
        .addEventListener("click", async function () {
          actionId = recommendation.recommendedActions[0].actionId;
          newTrainingData = await bandit.chooseAction(recommendation, actionId);
          trainingData = trainingData.concat(newTrainingData);
          document.getElementById("training-data").innerText =
            JSON.stringify(trainingData);
          document.getElementById("serialized-bandit").innerText =
            bandit.toJSON();
          generateNewRecommendation();
        });
      document
        .getElementById("eat-2")
        .addEventListener("click", async function () {
          actionId = recommendation.recommendedActions[1].actionId;
          newTrainingData = await bandit.chooseAction(recommendation, actionId);
          trainingData = trainingData.concat(newTrainingData);
          document.getElementById("training-data").innerText =
            JSON.stringify(trainingData);
          document.getElementById("serialized-bandit").innerText =
            bandit.toJSON();
          generateNewRecommendation();
        });
      document
        .getElementById("eat-3")
        .addEventListener("click", async function () {
          actionId = recommendation.recommendedActions[2].actionId;
          newTrainingData = await bandit.chooseAction(recommendation, actionId);
          trainingData = trainingData.concat(newTrainingData);
          document.getElementById("training-data").innerText =
            JSON.stringify(trainingData);
          document.getElementById("serialized-bandit").innerText =
            bandit.toJSON();
          generateNewRecommendation();
        });

      document
        .getElementById("dont-eat-button")
        .addEventListener("click", async function () {
          newTrainingData = await bandit.rejectAll(recommendation);
          trainingData = trainingData.concat(newTrainingData);
          document.getElementById("training-data").innerText =
            JSON.stringify(trainingData);
          document.getElementById("serialized-bandit").innerText =
            bandit.toJSON();
          generateNewRecommendation();
        });
    </script>
  </body>
</html>
